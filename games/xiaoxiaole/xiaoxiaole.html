<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <!-- ä¿®å¤viewportå…¨è§’æ ‡ç‚¹ï¼Œä¼˜åŒ–ç§»åŠ¨ç«¯é€‚é… -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>å¡é€šæ¶ˆæ¶ˆä¹</title>
  <style>
    /* ç»Ÿä¸€CSSå˜é‡å‘½åï¼ˆè‹±æ–‡ï¼‰ï¼Œå¢åŠ æµè§ˆå™¨å‰ç¼€æå‡å…¼å®¹æ€§ */
    :root {
      --game-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --board-bg: #ffffff;
      --border-color: #8b5cf6;
      --text-color: #2d3748;
      --score-bg: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
      --control-bg: rgba(139, 92, 246, 0.9);
      --control-active-bg: #ec4899;
      --block-size: 8vmin;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
      --glow: 0 0 15px rgba(139, 92, 246, 0.6);
    }

    /* ç»Ÿä¸€CSSå±æ€§æ‹¼å†™ï¼Œä¿®å¤å…¨è§’æ ‡ç‚¹ï¼Œå¢åŠ æµè§ˆå™¨å‰ç¼€ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Comic Sans MS', 'YouYuan', 'Microsoft YaHei', sans-serif;
      -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
    }

    body {
      background: var(--game-bg);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2vh 0;
      overflow: hidden;
      background-attachment: fixed;
    }

    .game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3vh;
      padding: 2vh;
      border-radius: 20px;
      background: rgba(255,255,255,0.8);
      box-shadow: var(--shadow);
      max-width: 95vw; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé€‚é…å¤§å± */
    }

    .game-header {
      display: flex;
      gap: 4vh;
      align-items: center;
      width: 100%;
      padding: 0 2vh;
      flex-wrap: wrap; /* é€‚é…å°å±ï¼Œé˜²æ­¢æŒ‰é’®æ¢è¡Œæº¢å‡º */
      justify-content: center;
    }

    .info-box {
      background: var(--score-bg);
      padding: 2vh 3vh;
      border-radius: 15px;
      border: none;
      text-align: center;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      min-width: 120px; /* ä¿è¯åˆ†æ•°æ¡†æœ€å°å®½åº¦ */
    }

    /* ä¿®å¤åŠ¨ç”»å‘½åå’Œé€‰æ‹©å™¨è¯­æ³• */
    .info-box::after {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shine 2s infinite;
    }

    @keyframes shine {
      100% { left: 100%; }
    }

    .info-box h2 {
      font-size: 2.5vmin;
      color: #ffffff;
      margin-bottom: 0.5vh;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    .info-box p {
      font-size: 4vmin;
      font-weight: bold;
      color: #ffffff;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      transition: all 0.3s ease; /* åˆ†æ•°å˜åŒ–åŠ¨ç”» */
    }

    #restart-btn {
      padding: 2vh 4vh;
      font-size: 2.8vmin;
      font-weight: bold;
      border: none;
      background: var(--control-bg);
      color: #ffffff;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      min-width: 100px; /* æŒ‰é’®æœ€å°å®½åº¦ */
    }

    #restart-btn::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    /* ä¿®å¤é€‰æ‹©å™¨å¤§å°å†™é”™è¯¯ï¼Œå¢åŠ activeçŠ¶æ€ */
    #restart-btn:hover {
      background: var(--control-active-bg);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(236, 72, 153, 0.4);
    }

    #restart-btn:active {
      transform: translateY(0); /* ç‚¹å‡»å›å¼¹æ•ˆæœ */
    }

    #restart-btn:hover::before {
      transform: translateX(100%);
    }

    /* ä¿®å¤IDå‘½åé”™è¯¯ï¼ˆæ¸¸æˆæ¿â†’game-boardï¼‰ */
    #game-board {
      display: grid;
      grid-template-columns: repeat(8, var(--block-size));
      grid-template-rows: repeat(8, var(--block-size));
      gap: 3px; /* ä¿®å¤å…¨è§’æ ‡ç‚¹ */
      background: var(--board-bg);
      padding: 2vh;
      border-radius: 15px;
      box-shadow: var(--shadow);
      border: 2px solid var(--border-color); /* ä¿®å¤å±æ€§æ‹¼å†™ */
      touch-action: manipulation; /* ç¦ç”¨ç§»åŠ¨ç«¯åŒå‡»ç¼©æ”¾ */
    }

    .block {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5vmin;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      position: relative;
      overflow: hidden;
      background: #ffffff;
      user-select: none; /* ç¦æ­¢é€‰ä¸­emoji */
    }

    .block::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.2) 100%);
      border-radius: 12px;
      pointer-events: none;
    }

    .block:hover {
      transform: scale(1.08);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .block.selected {
      border: 4px solid var(--border-color);
      box-shadow: var(--glow);
      transform: scale(1.1);
      z-index: 10; /* é€‰ä¸­æ—¶å±‚çº§æ›´é«˜ */
    }

    .block.eliminate { /* ä¿®å¤ç±»åï¼ˆæ¶ˆç­â†’eliminateï¼‰ */
      animation: eliminate 0.4s ease-in-out;
    }

    @keyframes eliminate {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2) rotate(15deg); opacity: 0.8; }
      100% { transform: scale(0) rotate(30deg); opacity: 0; }
    }

    /* æ°´æœæ ·å¼ä¼˜åŒ–ï¼Œå¢åŠ æ¸å˜è¿‡æ¸¡ */
    .fruit-1 { background: linear-gradient(135deg, #ff6b6b, #ff0d72); color: #fff; }
    .fruit-2 { background: linear-gradient(135deg, #4ecdc4, #0dc2ff); color: #fff; }
    .fruit-3 { background: linear-gradient(135deg, #4ade80, #0dff72); color: #fff; }
    .fruit-4 { background: linear-gradient(135deg, #d946ef, #f538ff); color: #fff; }
    .fruit-5 { background: linear-gradient(135deg, #f97316, #ff8e0d); color: #fff; }
    .fruit-6 { background: linear-gradient(135deg, #facc15, #ffe138); color: #fff; }
    .fruit-7 { background: linear-gradient(135deg, #3b82f6, #3877ff); color: #fff; }

    /* ä¿®å¤ä¸‹è½åŠ¨ç”»å‘½åå’Œé€‰æ‹©å™¨ */
    @keyframes drop {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .block.drop {
      animation: drop 0.3s ease-out;
    }

    /* åŠ è½½æç¤ºæ ·å¼ */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4vmin;
      color: #8b5cf6;
      z-index: 100;
    }
  </style>
</head>
<body>
  <div class="loading">æ¸¸æˆåŠ è½½ä¸­...</div>
  <div class="game-container">
    <div class="game-header">
      <div class="info-box">
        <h2>å½“å‰åˆ†æ•°</h2>
        <p id="score">0</p>
      </div>
      <button id="restart-btn">é‡æ–°å¼€å§‹</button>
    </div>
    <div id="game-board"></div>
  </div>

  <script>
    // ä¸¥æ ¼æ¨¡å¼ï¼Œå‡å°‘è¯­æ³•é”™è¯¯
    'use strict';

    // æ¸¸æˆé…ç½®ï¼ˆä¿®å¤å‘½åé”™è¯¯ï¼Œç»Ÿä¸€é©¼å³°å¼ï¼‰
    const CONFIG = {
      rows: 8,        // è¡Œæ•°ï¼ˆä¿®å¤æ‹¼å†™é”™è¯¯ï¼‰
      cols: 8,        // åˆ—æ•°ï¼ˆä¿®å¤æ‹¼å†™é”™è¯¯ï¼‰
      colorTypes: 7,  // æ°´æœç±»å‹æ•°ï¼ˆä¿®å¤å‘½åï¼‰
      matchCount: 3   // æ¶ˆé™¤æ‰€éœ€æ•°é‡
    };

    // æ°´æœemojiæ˜ å°„ï¼ˆä¿®å¤è¯­æ³•é”™è¯¯ï¼Œè¡¥å……é€—å·ï¼‰
    const FRUIT_EMOJIS = ['ğŸ', 'ğŸŠ', 'ğŸ', 'ğŸ‡', 'ğŸ‘', 'ğŸ‹', 'ğŸ“'];

    // DOMå…ƒç´ ï¼ˆä¿®å¤IDå‘½åï¼Œç»Ÿä¸€é©¼å³°å¼ï¼‰
    const gameBoard = document.getElementById('game-board');
    const scoreElement = document.getElementById('score');
    const restartBtn = document.getElementById('restart-btn');
    const loading = document.querySelector('.loading');

    // æ¸¸æˆçŠ¶æ€ï¼ˆä¿®å¤å˜é‡å‘½åï¼Œç»Ÿä¸€é©¼å³°å¼ï¼‰
    let board = [];
    let score = 0;
    let selectedBlock = null;
    let isEliminating = false;

    /**
     * åˆå§‹åŒ–æ¸¸æˆ
     */
    function initGame() {
      score = 0;
      scoreElement.textContent = score;
      selectedBlock = null;
      isEliminating = true; // åˆå§‹åŒ–æ—¶ç¦æ­¢æ“ä½œ
      gameBoard.innerHTML = '';

      // åˆå§‹åŒ–æ£‹ç›˜æ•°ç»„
      board = Array.from({ length: CONFIG.rows }, () =>
        Array.from({ length: CONFIG.cols }, () => 0)
      );

      // å¡«å……éšæœºæ°´æœï¼ˆç¡®ä¿åˆå§‹æ— æ¶ˆé™¤ï¼‰
      fillRandomColors();
      // åˆå§‹æ¸²æŸ“ï¼ˆæ·»åŠ ä¸‹è½åŠ¨ç”»ï¼‰
      renderBoard(true);
      
      // éšè—åŠ è½½æç¤ºï¼Œæ¢å¤æ“ä½œ
      loading.style.display = 'none';
      setTimeout(() => {
        isEliminating = false;
      }, 300);
    }

    /**
     * å¡«å……éšæœºæ°´æœï¼ˆç¡®ä¿åˆå§‹æ— æ¶ˆé™¤ï¼‰
     */
    function fillRandomColors() {
      do {
        for (let row = 0; row < CONFIG.rows; row++) {
          for (let col = 0; col < CONFIG.cols; col++) {
            board[row][col] = Math.floor(Math.random() * CONFIG.colorTypes) + 1;
          }
        }
      } while (getAllMatches().length > 0);
    }

    /**
     * æ¸²æŸ“æ£‹ç›˜ï¼ˆä¼˜åŒ–ï¼šå‡å°‘DOMæ“ä½œï¼Œå¤ç”¨å…ƒç´ ï¼‰
     * @param {boolean} addDropAnim - æ˜¯å¦æ·»åŠ ä¸‹è½åŠ¨ç”»
     */
    function renderBoard(addDropAnim = false) {
      // æ¸…ç©ºç°æœ‰å†…å®¹ï¼ˆåˆå§‹åŒ–æ—¶å·²æ¸…ç©ºï¼Œæ­¤å¤„ä¼˜åŒ–å¯å¤ç”¨å…ƒç´ ï¼Œæš‚ä¿ç•™ç®€æ´ç‰ˆï¼‰
      gameBoard.innerHTML = '';

      for (let row = 0; row < CONFIG.rows; row++) {
        for (let col = 0; col < CONFIG.cols; col++) {
          const block = document.createElement('div');
          const fruitType = board[row][col];
          
          // ä¿®å¤ç±»åæ‹¼æ¥ï¼ˆæ¨¡æ¿å­—ç¬¦ä¸²è¯­æ³•ï¼‰
          block.className = `block fruit-${fruitType} ${addDropAnim ? 'drop' : ''}`;
          block.dataset.row = row;
          block.dataset.col = col;
          block.textContent = FRUIT_EMOJIS[fruitType - 1];
          
          gameBoard.appendChild(block);
        }
      }
    }

    /**
     * å¤„ç†æ–¹å—ç‚¹å‡»ï¼ˆä¼˜åŒ–ï¼šäº‹ä»¶å§”æ‰˜ï¼Œå‡å°‘ç»‘å®šï¼‰
     * @param {Event} e - ç‚¹å‡»äº‹ä»¶
     */
    function handleBlockClick(e) {
      const block = e.target.closest('.block');
      if (!block || isEliminating || block === selectedBlock) return;

      const currentRow = parseInt(block.dataset.row);
      const currentCol = parseInt(block.dataset.col);

      // æœªé€‰ä¸­ä»»ä½•æ–¹å—ï¼šé€‰ä¸­å½“å‰æ–¹å—
      if (!selectedBlock) {
        selectedBlock = block;
        block.classList.add('selected');
        return;
      }

      const selectedRow = parseInt(selectedBlock.dataset.row);
      const selectedCol = parseInt(selectedBlock.dataset.col);

      // æ£€æŸ¥æ˜¯å¦ç›¸é‚»
      const isAdjacent = (
        (Math.abs(currentRow - selectedRow) === 1 && currentCol === selectedCol) ||
        (Math.abs(currentCol - selectedCol) === 1 && currentRow === selectedRow)
      );

      // ä¸ç›¸é‚»ï¼šåˆ‡æ¢é€‰ä¸­æ–¹å—
      if (!isAdjacent) {
        selectedBlock.classList.remove('selected');
        selectedBlock = block;
        block.classList.add('selected');
        return;
      }

      // ç›¸é‚»ï¼šäº¤æ¢æ–¹å—
      swapBlocks(selectedRow, selectedCol, currentRow, currentCol);
    }

    /**
     * äº¤æ¢ä¸¤ä¸ªæ–¹å—
     * @param {number} row1 - ç¬¬ä¸€ä¸ªæ–¹å—è¡Œ
     * @param {number} col1 - ç¬¬ä¸€ä¸ªæ–¹å—åˆ—
     * @param {number} row2 - ç¬¬äºŒä¸ªæ–¹å—è¡Œ
     * @param {number} col2 - ç¬¬äºŒä¸ªæ–¹å—åˆ—
     */
    function swapBlocks(row1, col1, row2, col2) {
      // å–æ¶ˆé€‰ä¸­çŠ¶æ€
      selectedBlock.classList.remove('selected');
      selectedBlock = null;

      // äº¤æ¢æ•°ç»„ä¸­çš„å€¼
      [board[row1][col1], board[row2][col2]] = [board[row2][col2], board[row1][col1]];
      // æ¸²æŸ“äº¤æ¢åçš„çŠ¶æ€
      renderBoard();

      // æ£€æŸ¥äº¤æ¢åæ˜¯å¦æœ‰å¯æ¶ˆé™¤çš„æ–¹å—
      setTimeout(() => {
        const matches = getAllMatches();
        if (matches.length > 0) {
          eliminateBlocks(matches);
        } else {
          // æ— æ¶ˆé™¤ï¼šè¿˜åŸäº¤æ¢
          [board[row1][col1], board[row2][col2]] = [board[row2][col2], board[row1][col1]];
          renderBoard();
        }
      }, 150);
    }

    /**
     * è·å–æ‰€æœ‰å¯æ¶ˆé™¤çš„æ–¹å—ï¼ˆä¼˜åŒ–ï¼šå‡å°‘å¾ªç¯æ¬¡æ•°ï¼‰
     * @returns {Array} å¯æ¶ˆé™¤æ–¹å—çš„åæ ‡æ•°ç»„
     */
    function getAllMatches() {
      const matches = new Set();

      // æ£€æŸ¥æ°´å¹³æ–¹å‘
      for (let row = 0; row < CONFIG.rows; row++) {
        for (let col = 0; col <= CONFIG.cols - CONFIG.matchCount; col++) {
          const color = board[row][col];
          if (color === 0) continue;

          // æ£€æŸ¥è¿ç»­åŒ¹é…
          let isMatch = true;
          for (let i = 1; i < CONFIG.matchCount; i++) {
            if (board[row][col + i] !== color) {
              isMatch = false;
              break;
            }
          }

          // è®°å½•åŒ¹é…çš„æ–¹å—
          if (isMatch) {
            for (let i = 0; i < CONFIG.matchCount; i++) {
              matches.add(`${row}-${col + i}`);
            }
          }
        }
      }

      // æ£€æŸ¥å‚ç›´æ–¹å‘
      for (let col = 0; col < CONFIG.cols; col++) {
        for (let row = 0; row <= CONFIG.rows - CONFIG.matchCount; row++) {
          const color = board[row][col];
          if (color === 0) continue;

          // æ£€æŸ¥è¿ç»­åŒ¹é…
          let isMatch = true;
          for (let i = 1; i < CONFIG.matchCount; i++) {
            if (board[row + i][col] !== color) {
              isMatch = false;
              break;
            }
          }

          // è®°å½•åŒ¹é…çš„æ–¹å—
          if (isMatch) {
            for (let i = 0; i < CONFIG.matchCount; i++) {
              matches.add(`${row + i}-${col}`);
            }
          }
        }
      }

      // è½¬æ¢ä¸ºåæ ‡å¯¹è±¡æ•°ç»„
      return Array.from(matches).map(pos => {
        const [row, col] = pos.split('-').map(Number);
        return { row, col };
      });
    }

    /**
     * æ¶ˆé™¤æ–¹å—å¹¶å¤„ç†åç»­é€»è¾‘
     * @param {Array} matches - å¯æ¶ˆé™¤æ–¹å—çš„åæ ‡æ•°ç»„
     */
    function eliminateBlocks(matches) {
      isEliminating = true;
      const matchCount = matches.length;

      // æ·»åŠ æ¶ˆé™¤åŠ¨ç”»
      matches.forEach(({ row, col }) => {
        const block = document.querySelector(`.block[data-row="${row}"][data-col="${col}"]`);
        if (block) block.classList.add('eliminate');
      });

      // è®¡ç®—åˆ†æ•°ï¼ˆä¼˜åŒ–ï¼šè¿é”æ¶ˆé™¤åŠ åˆ†ï¼‰
      const addScore = matchCount * 10 + (matchCount > CONFIG.matchCount ? (matchCount - CONFIG.matchCount) * 5 : 0);
      score += addScore;
      scoreElement.textContent = score;

      // åˆ†æ•°æ”¾å¤§åŠ¨ç”»
      scoreElement.animate([
        { transform: 'scale(1)' },
        { transform: 'scale(1.2)' },
        { transform: 'scale(1)' }
      ], { duration: 300 });

      // ç­‰å¾…æ¶ˆé™¤åŠ¨ç”»ç»“æŸåå¤„ç†ä¸‹è½
      setTimeout(() => {
        // æ¸…ç©ºæ¶ˆé™¤çš„æ–¹å—
        matches.forEach(({ row, col }) => {
          board[row][col] = 0;
        });

        // å¤„ç†æ–¹å—ä¸‹è½
        dropBlocks();

        // æ£€æŸ¥è¿é”æ¶ˆé™¤
        setTimeout(() => {
          const newMatches = getAllMatches();
          if (newMatches.length > 0) {
            eliminateBlocks(newMatches); // é€’å½’å¤„ç†è¿é”æ¶ˆé™¤
          } else {
            isEliminating = false; // æ¢å¤æ“ä½œ
          }
        }, 300);
      }, 400);
    }

    /**
     * å¤„ç†æ–¹å—ä¸‹è½å¹¶è¡¥å……æ–°æ–¹å—ï¼ˆä¿®å¤æ‹¼å†™é”™è¯¯ï¼‰
     */
    function dropBlocks() {
      for (let col = 0; col < CONFIG.cols; col++) {
        const newCol = [];
        let emptyCount = 0;

        // æ”¶é›†éç©ºæ–¹å—
        for (let row = 0; row < CONFIG.rows; row++) {
          if (board[row][col] === 0) {
            emptyCount++;
          } else {
            newCol.push(board[row][col]);
          }
        }

        // è¡¥å……æ–°æ–¹å—åˆ°é¡¶éƒ¨
        while (emptyCount > 0) {
          newCol.unshift(Math.floor(Math.random() * CONFIG.colorTypes) + 1);
          emptyCount--;
        }

        // æ›´æ–°åˆ—æ•°æ®
        for (let row = 0; row < CONFIG.rows; row++) {
          board[row][col] = newCol[row];
        }
      }

      // æ¸²æŸ“ä¸‹è½åçš„æ£‹ç›˜ï¼ˆæ·»åŠ ä¸‹è½åŠ¨ç”»ï¼‰
      renderBoard(true);
    }

    // äº‹ä»¶ç»‘å®šï¼ˆä¼˜åŒ–ï¼šäº‹ä»¶å§”æ‰˜ï¼Œå‡å°‘ç»‘å®šï¼‰
    gameBoard.addEventListener('click', handleBlockClick);
    restartBtn.addEventListener('click', initGame);
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
    window.addEventListener('load', initGame);

    // é€‚é…ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶
    gameBoard.addEventListener('touchstart', (e) => {
      e.preventDefault(); // é˜²æ­¢è§¦æ‘¸æ»šåŠ¨
      handleBlockClick(e);
    }, { passive: false });
  </script>
</body>
</html>
